(window.webpackJsonp=window.webpackJsonp||[]).push([[16],{1097:function(e,t,n){"use strict";n.r(t),n.d(t,"getLayer",(function(){return B}));var a=n(1),o=n.n(a),i=n(0),r=n.n(i),l=n(894),s=n(895),c=n(897),u=n(896),g=n(909),d=n(898),h=n(901),f=n(983),m=n(917),p=n(1017),v=n(960),C=n(935),x=n(955),y=n(929),b=n(1235),S=n(1093),M=n(1026),w=n(949),_=h.a.count,A=[0,0,0,0],P=[0,255,0,255],R=["minColor","maxColor","colorRange","colorDomain"],k={cellSizePixels:{value:100,min:1},cellMarginPixels:{value:2,min:0,max:5},colorDomain:null,colorRange:C.b,getPosition:{type:"accessor",value:function(e){return e.position}},getWeight:{type:"accessor",value:function(e){return[1,0,0]}},gpuAggregation:!0,aggregation:"SUM"},D=function(e){function t(){return Object(l.a)(this,t),Object(c.a)(this,Object(u.a)(t).apply(this,arguments))}return Object(d.a)(t,e),Object(s.a)(t,[{key:"getShaders",value:function(){var e=Object(b.d)(this.context.gl)?{vs:"#version 300 es\n#define SHADER_NAME screen-grid-layer-vertex-shader\n#define RANGE_COUNT 6\n\nin vec3 positions;\nin vec3 instancePositions;\nin vec4 instanceCounts;\nin vec3 instancePickingColors;\n\nlayout(std140) uniform;\nuniform float opacity;\nuniform vec3 cellScale;\nuniform vec4 minColor;\nuniform vec4 maxColor;\nuniform AggregationData\n{\n  vec4 maxCount;\n} aggregationData;\n\nuniform vec4 colorRange[RANGE_COUNT];\nuniform vec2 colorDomain;\nuniform bool shouldUseMinMax;\n\nout vec4 vColor;\nout float vSampleCount;\n\nvec4 quantizeScale(vec2 domain, vec4 range[RANGE_COUNT], float value) {\n  vec4 outColor = vec4(0., 0., 0., 0.);\n  if (value >= domain.x && value <= domain.y) {\n    float domainRange = domain.y - domain.x;\n    if (domainRange <= 0.) {\n      outColor = colorRange[0];\n    } else {\n      float rangeCount = float(RANGE_COUNT);\n      float rangeStep = domainRange / rangeCount;\n      float idx = floor((value - domain.x) / rangeStep);\n      idx = clamp(idx, 0., rangeCount - 1.);\n      int intIdx = int(idx);\n      outColor = colorRange[intIdx];\n    }\n  }\n  outColor = outColor / 255.;\n  return outColor;\n}\n\nvoid main(void) {\n  vSampleCount = instanceCounts.a;\n\n  float weight = instanceCounts.r ;\n  float maxWeight = aggregationData.maxCount.r;\n  float step = weight / maxWeight;\n  vec4 minMaxColor = mix(minColor, maxColor, step) / 255.;\n\n  vec2 domain = colorDomain;\n  float domainMaxValid = float(colorDomain.y != 0.);\n  domain.y = mix(maxWeight, colorDomain.y, domainMaxValid);\n  vec4 rangeColor = quantizeScale(domain, colorRange, weight);\n\n  float rangeMinMax = float(shouldUseMinMax);\n  vec4 color = mix(rangeColor, minMaxColor, rangeMinMax);\n  vColor = vec4(color.rgb, color.a * opacity);\n  picking_setPickingColor(instancePickingColors);\n\n  gl_Position = vec4(instancePositions + positions * cellScale, 1.);\n}\n",fs:"#version 300 es\n#define SHADER_NAME screen-grid-layer-fragment-shader\n\nprecision highp float;\n\nin vec4 vColor;\nin float vSampleCount;\nout vec4 fragColor;\n\nvoid main(void) {\n  if (vSampleCount <= 0.0) {\n    discard;\n  }\n  fragColor = vColor;\n\n  fragColor = picking_filterColor(fragColor);\n}\n"}:{vs:"#define SHADER_NAME screen-grid-layer-vertex-shader-webgl1\n#define RANGE_COUNT 6\n\nattribute vec3 positions;\nattribute vec3 instancePositions;\nattribute vec4 instanceCounts;\nattribute vec3 instancePickingColors;\n\nuniform float opacity;\nuniform vec3 cellScale;\nuniform vec4 minColor;\nuniform vec4 maxColor;\nuniform float maxWeight;\nuniform vec4 colorRange[RANGE_COUNT];\nuniform vec2 colorDomain;\nuniform bool shouldUseMinMax;\n\nvarying vec4 vColor;\nvarying float vSampleCount;\n\nvec4 quantizeScale(vec2 domain, vec4 range[RANGE_COUNT], float value) {\n  vec4 outColor = vec4(0., 0., 0., 0.);\n  if (value >= domain.x && value <= domain.y) {\n    float domainRange = domain.y - domain.x;\n    if (domainRange <= 0.) {\n      outColor = colorRange[0];\n    } else {\n      float rangeCount = float(RANGE_COUNT);\n      float rangeStep = domainRange / rangeCount;\n      float idx = floor((value - domain.x) / rangeStep);\n      idx = clamp(idx, 0., rangeCount - 1.);\n      int intIdx = int(idx);\n      outColor = colorRange[intIdx];\n    }\n  }\n  outColor = outColor / 255.;\n  return outColor;\n}\n\nvoid main(void) {\n  vSampleCount = instanceCounts.a;\n\n  float weight = instanceCounts.r;\n  float step = weight / maxWeight;\n  vec4 minMaxColor = mix(minColor, maxColor, step) / 255.;\n\n  vec2 domain = colorDomain;\n  float domainMaxValid = float(colorDomain.y != 0.);\n  domain.y = mix(maxWeight, colorDomain.y, domainMaxValid);\n  vec4 rangeColor = quantizeScale(domain, colorRange, weight);\n\n  float rangeMinMax = float(shouldUseMinMax);\n  vec4 color = mix(rangeColor, minMaxColor, rangeMinMax);\n  vColor = vec4(color.rgb, color.a * opacity);\n  picking_setPickingColor(instancePickingColors);\n\n  gl_Position = vec4(instancePositions + positions * cellScale, 1.);\n}\n",fs:"#define SHADER_NAME screen-grid-layer-fragment-shader-webgl1\n\nprecision highp float;\n\nvarying vec4 vColor;\nvarying float vSampleCount;\n\nvoid main(void) {\n  if (vSampleCount <= 0.0) {\n    discard;\n  }\n  gl_FragColor = vColor;\n\n  gl_FragColor = picking_filterColor(gl_FragColor);\n}\n"};return e.modules=["picking"],e}},{key:"initializeState",value:function(){var e=this.getAttributeManager(),t=this.context.gl;e.addInstanced({instancePositions:{size:3,update:this.calculateInstancePositions},instanceCounts:{size:4,transition:!0,accessor:["getPosition","getWeight"],update:this.calculateInstanceCounts,noAlloc:!0}});var n={id:"".concat(this.id,"-aggregator"),shaderCache:this.context.shaderCache},a=this._getMaxCountBuffer(t),o={color:{size:1,operation:y.a.SUM,needMax:!0,maxBuffer:a}};this.setState({model:this._getModel(t),gpuGridAggregator:new x.a(t,n),maxBuffer:a,weights:o}),this._setupUniformBuffer()}},{key:"shouldUpdateState",value:function(e){return e.changeFlags.somethingChanged}},{key:"updateState",value:function(e){Object(g.a)(Object(u.a)(t.prototype),"updateState",this).call(this,e),this._updateUniforms(e),e.changeFlags.dataChanged&&this._processData();var n=this._getAggregationChangeFlags(e);n&&this._updateAggregation(n)}},{key:"finalizeState",value:function(){Object(g.a)(Object(u.a)(t.prototype),"finalizeState",this).call(this);var e=this.state,n=e.aggregationBuffer,a=e.maxBuffer;e.gpuGridAggregator.delete(),n&&n.delete(),a&&a.delete()}},{key:"draw",value:function(e){var t=e.uniforms,n=this.context.gl,a=this.props.parameters,o=void 0===a?{}:a,i=this.props.minColor||A,r=this.props.maxColor||P,l=this.props.colorDomain||[1,0],s=this.state,c=s.model,u=s.maxBuffer,g=s.cellScale,d=s.shouldUseMinMax,h=s.colorRange,f=s.maxWeight,m={minColor:i,maxColor:r,cellScale:g,colorRange:h,colorDomain:l,shouldUseMinMax:d};Object(b.d)(n)?u.bind({target:35345}):m.maxWeight=f,t=Object.assign(m,t),c.draw({uniforms:t,parameters:Object.assign({depthTest:!1,depthMask:!1},o)}),Object(b.d)(n)&&u.unbind()}},{key:"calculateInstancePositions",value:function(e,t){for(var n=t.numInstances,a=this.context.viewport,o=a.width,i=a.height,r=this.props.cellSizePixels,l=this.state.numCol,s=e.value,c=e.size,u=0;u<n;u++){var g=u%l,d=Math.floor(u/l);s[u*c+0]=g*r/o*2-1,s[u*c+1]=1-d*r/i*2,s[u*c+2]=0}}},{key:"calculateInstanceCounts",value:function(e,t){t.numInstances;var n=this.state.aggregationBuffer;e.update({buffer:n})}},{key:"getPickingInfo",value:function(e){var t=e.info,n=(e.mode,t.index);if(n>=0){var a=this.state.gpuGridAggregator.getData("color");t.object=x.a.getAggregationData(Object.assign({pixelIndex:n},a))}return t}},{key:"_getAggregationChangeFlags",value:function(e){var t=e.oldProps,n=e.props,a=e.changeFlags,o=n.cellSizePixels!==t.cellSizePixels||n.cellMarginPixels!==t.cellMarginPixels,i=a.dataChanged||n.aggregation!==t.aggregation,r=a.viewportChanged;return o||i||r?{cellSizeChanged:o,dataChanged:i,viewportChanged:r}:null}},{key:"_getModel",value:function(e){return new S.a(e,Object.assign({},this.getShaders(),{id:this.props.id,geometry:new M.a({drawMode:6,attributes:{positions:new Float32Array([0,0,0,1,0,0,1,1,0,0,1,0])}}),isInstanced:!0,shaderCache:this.context.shaderCache}))}},{key:"_getMaxCountBuffer",value:function(e){return new w.a(e,{byteLength:16,index:0,accessor:{size:4}})}},{key:"_processData",value:function(){var e=this.props,t=e.data,n=e.getPosition,a=e.getWeight,o=_(t),i=new Float64Array(2*o),r=new Float32Array(3*o),l=this.state.weights,s=Object(f.a)(t),c=s.iterable,u=s.objectInfo,g=!0,d=!1,h=void 0;try{for(var m,p=c[Symbol.iterator]();!(g=(m=p.next()).done);g=!0){var v=m.value;u.index++;var C=n(v,u),x=a(v,u),y=u.index;i[2*y]=C[0],i[2*y+1]=C[1],Array.isArray(x)?(r[3*y]=x[0],r[3*y+1]=x[1],r[3*y+2]=x[2]):r[3*y]=x}}catch(e){d=!0,h=e}finally{try{g||null==p.return||p.return()}finally{if(d)throw h}}l.color.values=r,this.setState({positions:i})}},{key:"_setupUniformBuffer",value:function(){var e=this.context.gl;if(Object(b.d)(e)){var t=this.state.model.program.handle,n=e.getUniformBlockIndex(t,"AggregationData");e.uniformBlockBinding(t,n,0)}}},{key:"_shouldUseMinMax",value:function(){var e=this.props,t=e.minColor,n=e.maxColor,a=e.colorDomain,o=e.colorRange;return t||n?(m.a.deprecated("ScreenGridLayer props: minColor and maxColor","colorRange, colorDomain")(),!0):!a&&!o}},{key:"_updateAggregation",value:function(e){var t=this.getAttributeManager();(e.cellSizeChanged||e.viewportChanged)&&(this._updateGridParams(),t.invalidateAll());var n=this.props,a=n.cellSizePixels,o=n.gpuAggregation,i=this.state,r=i.positions,l=i.weights,s=this.context.viewport;l.color.operation=y.a[this.props.aggregation.toUpperCase()]||y.a.SUM;var c=!1,u=null;this.context.viewport instanceof p.a?c=!0:(c=!1,u=s.pixelProjectionMatrix);var g=this.state.gpuGridAggregator.run({positions:r,weights:l,cellSize:[a,a],viewport:s,changeFlags:e,useGPU:o,projectPoints:c,gridTransformMatrix:u}),d=g.color.maxData&&Number.isFinite(g.color.maxData[0])?g.color.maxData[0]:0;this.setState({maxWeight:d}),t.invalidate("instanceCounts")}},{key:"_updateUniforms",value:function(e){var t=e.oldProps,n=e.props,a=e.changeFlags,o={};if(R.some((function(e){return t[e]!==n[e]}))&&(o.shouldUseMinMax=this._shouldUseMinMax()),t.colorRange!==n.colorRange&&(o.colorRange=Object(C.a)(n.colorRange,Float32Array,255)),t.cellMarginPixels!==n.cellMarginPixels||t.cellSizePixels!==n.cellSizePixels||a.viewportChanged){var i=this.context.viewport,r=i.width,l=i.height,s=this.props,c=s.cellSizePixels,u=s.cellMarginPixels,g=c>u?u:0;o.cellScale=new Float32Array([(c-g)/r*2,-(c-g)/l*2,1])}this.setState(o)}},{key:"_updateGridParams",value:function(){var e=this.context.viewport,t=e.width,n=e.height,a=this.props.cellSizePixels,o=this.context.gl,i=Math.ceil(t/a),r=Math.ceil(n/a),l=i*r,s=4*l*4,c=this.state.aggregationBuffer;c&&c.delete(),c=new w.a(o,{byteLength:s,accessor:{size:4,type:5126,divisor:1}}),this.state.weights.color.aggregationBuffer=c,this.setState({numCol:i,numRow:r,numInstances:l,aggregationBuffer:c})}}]),t}(v.a);D.layerName="ScreenGridLayer",D.defaultProps=k;var j=n(874),O=n(930),N=n(928),U=n(905),z=n(913),F=n(915),E=n(919);function I(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function G(e){return o.a.createElement("div",{className:"deckgl-tooltip"},o.a.createElement(F.a,{label:Object(j.b)("Longitude and Latitude")+": ",value:e.coordinate[0]+", "+e.coordinate[1]}),o.a.createElement(F.a,{label:Object(j.b)("Weight")+": ",value:""+e.object.weight}))}function B(e,t,n,a,o,i,r){const l=e,s=l.color_picker;let c=t.data.features.map(e=>({...e,color:[s.r,s.g,s.b,255*s.a]}));if(l.js_data_mutator){const e=Object(U.a)(l.js_data_mutator);c=e(c)}return null!=r&&r.forEach(e=>{c=c.filter(t=>e(t))}),new D({id:"screengrid-layer-"+l.slice_id,data:c,pickable:!0,cellSizePixels:l.grid_size,minColor:[s.r,s.g,s.b,0],maxColor:[s.r,s.g,s.b,255*s.a],outline:!1,getWeight:e=>e.weight||0,...Object(z.a)(l,a,G)})}const T={formData:r.a.object.isRequired,payload:r.a.object.isRequired,setControlValue:r.a.func.isRequired,viewport:r.a.object.isRequired,onAddFilter:r.a.func,width:r.a.number.isRequired,height:r.a.number.isRequired},V={onAddFilter(){}};class W extends o.a.PureComponent{constructor(e){super(e),I(this,"containerRef",o.a.createRef()),I(this,"setTooltip",e=>{const{current:t}=this.containerRef;t&&t.setTooltip(e)}),this.state=W.getDerivedStateFromProps(e),this.getLayers=this.getLayers.bind(this),this.onValuesChange=this.onValuesChange.bind(this)}static getDerivedStateFromProps(e,t){if(t&&e.payload.form_data===t.formData)return null;const n=e.payload.data.features||[],a=n.map(e=>e.__timestamp),o=e.payload.form_data.time_grain_sqla||e.payload.form_data.granularity||"P1D",{start:i,end:r,getStep:l,values:s,disabled:c}=Object(N.a)(a,o),{width:u,height:g,formData:d}=e;let{viewport:h}=e;var f;return d.autozoom&&(h=Object(E.a)(h,{width:u,height:g,points:(f=n,f.map(e=>e.position))})),{start:i,end:r,getStep:l,values:s,disabled:c,viewport:h,selected:[],lastClick:0,formData:e.payload.form_data}}onValuesChange(e){this.setState({values:Array.isArray(e)?e:[e,e+this.state.getStep(e)]})}getLayers(e){const t=[];e[0]===e[1]||e[1]===this.end?t.push(t=>t.__timestamp>=e[0]&&t.__timestamp<=e[1]):t.push(t=>t.__timestamp>=e[0]&&t.__timestamp<e[1]);return[B(this.props.formData,this.props.payload,this.props.onAddFilter,this.setTooltip)]}render(){const{formData:e,payload:t,setControlValue:n}=this.props;return o.a.createElement("div",null,o.a.createElement(O.a,{ref:this.containerRef,aggregation:!0,getLayers:this.getLayers,start:this.state.start,end:this.state.end,getStep:this.state.getStep,values:this.state.values,disabled:this.state.disabled,viewport:this.state.viewport,width:this.props.width,height:this.props.height,mapboxApiAccessToken:t.data.mapboxApiKey,mapStyle:e.mapbox_style,setControlValue:n,onValuesChange:this.onValuesChange,onViewportChange:this.onViewportChange}))}}W.propTypes=T,W.defaultProps=V;t.default=W},929:function(e,t,n){"use strict";n.d(t,"a",(function(){return a})),n.d(t,"b",(function(){return l}));var a={SUM:1,MEAN:2,MIN:3,MAX:4};function o(e,t){return e+t}function i(e,t){return t>e?t:e}function r(e,t){return t<e?t:e}function l(e,t){switch(a[e.toUpperCase()]||a.SUM){case a.MIN:return function(e){return function(e,t){var n=e.map(t).filter(Number.isFinite);return n.length?n.reduce(r,1/0):null}(e,t)};case a.SUM:return function(e){return function(e,t){var n=e.map(t).filter(Number.isFinite);return n.length?n.reduce(o,0):null}(e,t)};case a.MEAN:return function(e){return function(e,t){var n=e.map(t).filter(Number.isFinite);return n.length?n.reduce(o,0)/n.length:null}(e,t)};case a.MAX:return function(e){return function(e,t){var n=e.map(t).filter(Number.isFinite);return n.length?n.reduce(i,-1/0):null}(e,t)};default:return null}}},935:function(e,t,n){"use strict";n.d(t,"b",(function(){return a})),n.d(t,"a",(function(){return o}));var a=[[255,255,178],[254,217,118],[254,178,76],[253,141,60],[240,59,32],[189,0,38]];function o(e,t,n){var a=new t(4*e.length);return e.forEach((function(e,t){var o=4*t;a[o]=e[0],a[o+1]=e[1],a[o+2]=e[2],a[o+3]=Number.isFinite(e[3])?e[3]:n})),a}}}]);